# NGINX Plus Proxy with NGINX Agent
# NGINX webservers with ingress-demo pages
# NGINX Basics, Feb 2025
# Chris Akker, Shouvik Dutta, Adam Currier
#
services:
  nginx-plus:                  # NGINX Plus Web / Load Balancer
    environment:
      NGINX_AGENT_SERVER_HOST: 'agent.connect.nginx.com'
      NGINX_AGENT_SERVER_GRPCPORT: '443'
      NGINX_AGENT_TLS_ENABLE: 'true'
      NGINX_AGENT_SERVER_TOKEN: $TOKEN # Datakey From One Console
    hostname: $NAME-nginx-plus
    container_name: $NAME-nginx-plus
    image: private-registry.nginx.com/nginx-plus/agent:nginx-plus-r32-alpine-3.20-20240613 # CVE - From Nginx Private Registry
    volumes:  # Sync these folders to container
        - ./nginx-plus/etc/nginx/nginx.conf:/etc/nginx/nginx.conf
        - ./nginx-plus/etc/nginx/conf.d:/etc/nginx/conf.d
        - ./nginx-plus/etc/nginx/includes:/etc/nginx/includes
        - ./nginx-plus/usr/share/nginx/html:/usr/share/nginx/html
    ports:
        - 80:80       # Open for HTTP
        - 443:443     # Open for HTTPS
        - 9000:9000   # Open for API / dashboard page
    restart: always 
  #    
  web1:
      hostname: $NAME-web1
      container_name: $NAME-web1
      image: nginxinc/ingress-demo            # Image from Docker Hub
      ports:
        - "80"                                # Open for HTTP
        - "443"                               # Open for HTTPS
  web2:
      hostname: $NAME-web2
      container_name: $NAME-web2
      image: nginxinc/ingress-demo
      ports:
        - "80"
        - "433"
  web3:
      hostname: $NAME-web3
      container_name: $NAME-web3
      image: nginxinc/ingress-demo
      ports:
        - "80"
        - "443"     